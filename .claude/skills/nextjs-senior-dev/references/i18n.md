# Internationalization (i18n)

## next-intl Setup

### Installation

```bash
npm install next-intl
```

### Project Structure

```
src/
├── app/
│   └── [locale]/           # Dynamic locale segment
│       ├── layout.tsx
│       ├── page.tsx
│       └── about/
│           └── page.tsx
├── i18n/
│   ├── request.ts          # Server config
│   ├── routing.ts          # Routing config
│   └── navigation.ts       # Navigation helpers
└── messages/
    ├── en.json
    ├── de.json
    └── fr.json
```

### Configuration

```typescript
// i18n/routing.ts
import { defineRouting } from "next-intl/routing"

export const routing = defineRouting({
  locales: ["en", "de", "fr"],
  defaultLocale: "en",
  localePrefix: "as-needed", // "always" | "as-needed" | "never"
})

export type Locale = (typeof routing.locales)[number]
```

```typescript
// i18n/request.ts
import { getRequestConfig } from "next-intl/server"
import { routing } from "./routing"

export default getRequestConfig(async ({ requestLocale }) => {
  let locale = await requestLocale

  // Validate locale
  if (!locale || !routing.locales.includes(locale as any)) {
    locale = routing.defaultLocale
  }

  return {
    locale,
    messages: (await import(`../messages/${locale}.json`)).default,
  }
})
```

```typescript
// i18n/navigation.ts
import { createNavigation } from "next-intl/navigation"
import { routing } from "./routing"

export const { Link, redirect, usePathname, useRouter, getPathname } =
  createNavigation(routing)
```

### Middleware

```typescript
// middleware.ts
import createMiddleware from "next-intl/middleware"
import { routing } from "./i18n/routing"

export default createMiddleware(routing)

export const config = {
  matcher: [
    // Match all pathnames except for
    // - API routes
    // - Static files
    // - Next.js internals
    "/((?!api|_next|_vercel|.*\\..*).*)",
  ],
}
```

### Root Layout

```typescript
// app/[locale]/layout.tsx
import { NextIntlClientProvider } from "next-intl"
import { getMessages, getTranslations } from "next-intl/server"
import { notFound } from "next/navigation"
import { routing } from "@/i18n/routing"

interface Props {
  children: React.ReactNode
  params: Promise<{ locale: string }>
}

export function generateStaticParams() {
  return routing.locales.map((locale) => ({ locale }))
}

export async function generateMetadata({ params }: Props) {
  const { locale } = await params
  const t = await getTranslations({ locale, namespace: "Metadata" })

  return {
    title: t("title"),
    description: t("description"),
  }
}

export default async function LocaleLayout({ children, params }: Props) {
  const { locale } = await params

  // Validate locale
  if (!routing.locales.includes(locale as any)) {
    notFound()
  }

  const messages = await getMessages()

  return (
    <html lang={locale}>
      <body>
        <NextIntlClientProvider messages={messages}>
          {children}
        </NextIntlClientProvider>
      </body>
    </html>
  )
}
```

## Message Files

### Basic Messages

```json
// messages/en.json
{
  "Metadata": {
    "title": "My App",
    "description": "Welcome to my application"
  },
  "Navigation": {
    "home": "Home",
    "about": "About",
    "contact": "Contact"
  },
  "HomePage": {
    "title": "Welcome",
    "description": "This is the home page"
  },
  "Common": {
    "loading": "Loading...",
    "error": "An error occurred",
    "submit": "Submit",
    "cancel": "Cancel"
  }
}
```

### With Interpolation

```json
// messages/en.json
{
  "Greeting": {
    "hello": "Hello, {name}!",
    "welcome": "Welcome back, {name}. You have {count, plural, =0 {no messages} one {1 message} other {{count} messages}}."
  },
  "Products": {
    "price": "Price: {price, number, currency}",
    "date": "Added on {date, date, medium}",
    "inStock": "{count, plural, =0 {Out of stock} one {1 item left} other {{count} items in stock}}"
  }
}
```

## Server Components

```typescript
// app/[locale]/page.tsx
import { getTranslations } from "next-intl/server"

export default async function HomePage() {
  const t = await getTranslations("HomePage")

  return (
    <main>
      <h1>{t("title")}</h1>
      <p>{t("description")}</p>
    </main>
  )
}
```

### With Interpolation

```typescript
// app/[locale]/products/[id]/page.tsx
import { getTranslations, getFormatter } from "next-intl/server"

export default async function ProductPage({ params }) {
  const t = await getTranslations("Products")
  const format = await getFormatter()

  const product = await getProduct(params.id)

  return (
    <div>
      <h1>{product.name}</h1>
      <p>{t("price", { price: product.price })}</p>
      <p>{t("date", { date: new Date(product.createdAt) })}</p>
      <p>{t("inStock", { count: product.stock })}</p>

      {/* Direct formatting */}
      <p>{format.number(product.price, { style: "currency", currency: "USD" })}</p>
      <p>{format.dateTime(product.createdAt, { dateStyle: "full" })}</p>
    </div>
  )
}
```

## Client Components

```typescript
// components/Greeting.interactive.tsx
"use client"

import { useTranslations } from "next-intl"

export function Greeting({ name }: { name: string }) {
  const t = useTranslations("Greeting")

  return <p>{t("hello", { name })}</p>
}
```

### With Formatting

```typescript
// components/ProductCard.interactive.tsx
"use client"

import { useTranslations, useFormatter } from "next-intl"

interface Product {
  name: string
  price: number
  createdAt: Date
}

export function ProductCard({ product }: { product: Product }) {
  const t = useTranslations("Products")
  const format = useFormatter()

  return (
    <div>
      <h3>{product.name}</h3>
      <p>{format.number(product.price, { style: "currency", currency: "USD" })}</p>
      <p>{format.relativeTime(product.createdAt)}</p>
    </div>
  )
}
```

## Language Switcher

```typescript
// components/LanguageSwitcher.interactive.tsx
"use client"

import { useLocale } from "next-intl"
import { useRouter, usePathname } from "@/i18n/navigation"
import { routing } from "@/i18n/routing"

const localeNames: Record<string, string> = {
  en: "English",
  de: "Deutsch",
  fr: "Français",
}

export function LanguageSwitcher() {
  const locale = useLocale()
  const router = useRouter()
  const pathname = usePathname()

  const handleChange = (newLocale: string) => {
    router.replace(pathname, { locale: newLocale })
  }

  return (
    <select
      value={locale}
      onChange={(e) => handleChange(e.target.value)}
      aria-label="Select language"
    >
      {routing.locales.map((loc) => (
        <option key={loc} value={loc}>
          {localeNames[loc]}
        </option>
      ))}
    </select>
  )
}
```

## Localized Navigation

```typescript
// components/Navigation.tsx
import { Link } from "@/i18n/navigation"
import { getTranslations } from "next-intl/server"

export async function Navigation() {
  const t = await getTranslations("Navigation")

  return (
    <nav>
      <Link href="/">{t("home")}</Link>
      <Link href="/about">{t("about")}</Link>
      <Link href="/contact">{t("contact")}</Link>
    </nav>
  )
}
```

## RTL Support

### Layout Configuration

```typescript
// app/[locale]/layout.tsx
import { getLocale } from "next-intl/server"

const rtlLocales = ["ar", "he", "fa"]

export default async function LocaleLayout({ children, params }) {
  const { locale } = await params
  const dir = rtlLocales.includes(locale) ? "rtl" : "ltr"

  return (
    <html lang={locale} dir={dir}>
      <body className={dir === "rtl" ? "font-arabic" : ""}>
        {children}
      </body>
    </html>
  )
}
```

### CSS for RTL

```css
/* styles/globals.css */
[dir="rtl"] {
  /* Flip layout */
  --direction: rtl;
}

[dir="ltr"] {
  --direction: ltr;
}

/* Use logical properties */
.container {
  padding-inline-start: 1rem;
  padding-inline-end: 1rem;
  margin-inline: auto;
}

/* Or use Tailwind RTL plugin */
/* @tailwindcss/rtl */
```

## Locale Detection

```typescript
// middleware.ts
import createMiddleware from "next-intl/middleware"
import { routing } from "./i18n/routing"

export default createMiddleware(routing, {
  // Detect locale from Accept-Language header
  localeDetection: true,
})
```

### Custom Detection

```typescript
// middleware.ts
import { NextRequest, NextResponse } from "next/server"
import createMiddleware from "next-intl/middleware"
import { routing } from "./i18n/routing"

const intlMiddleware = createMiddleware(routing)

export default function middleware(request: NextRequest) {
  // Check for locale in cookie first
  const cookieLocale = request.cookies.get("NEXT_LOCALE")?.value

  if (cookieLocale && routing.locales.includes(cookieLocale as any)) {
    // Set header for intl middleware
    const response = intlMiddleware(request)
    return response
  }

  return intlMiddleware(request)
}
```

## SEO for Multilingual

### Alternate Links

```typescript
// app/[locale]/layout.tsx
export async function generateMetadata({ params }: Props) {
  const { locale } = await params
  const t = await getTranslations({ locale, namespace: "Metadata" })

  return {
    title: t("title"),
    description: t("description"),
    alternates: {
      canonical: `https://example.com/${locale}`,
      languages: {
        en: "https://example.com/en",
        de: "https://example.com/de",
        fr: "https://example.com/fr",
        "x-default": "https://example.com",
      },
    },
  }
}
```

### Multilingual Sitemap

```typescript
// app/sitemap.ts
import { routing } from "@/i18n/routing"
import type { MetadataRoute } from "next"

export default function sitemap(): MetadataRoute.Sitemap {
  const baseUrl = "https://example.com"
  const pages = ["/", "/about", "/contact", "/products"]

  const entries: MetadataRoute.Sitemap = []

  for (const page of pages) {
    for (const locale of routing.locales) {
      entries.push({
        url: `${baseUrl}/${locale}${page === "/" ? "" : page}`,
        lastModified: new Date(),
        changeFrequency: "weekly",
        priority: page === "/" ? 1 : 0.8,
        alternates: {
          languages: Object.fromEntries(
            routing.locales.map((loc) => [
              loc,
              `${baseUrl}/${loc}${page === "/" ? "" : page}`,
            ])
          ),
        },
      })
    }
  }

  return entries
}
```

## Date/Number Formatting

### Configuring Formats

```typescript
// i18n/request.ts
export default getRequestConfig(async ({ requestLocale }) => {
  const locale = await requestLocale

  return {
    locale,
    messages: (await import(`../messages/${locale}.json`)).default,
    formats: {
      dateTime: {
        short: {
          day: "numeric",
          month: "short",
          year: "numeric",
        },
        long: {
          day: "numeric",
          month: "long",
          year: "numeric",
          weekday: "long",
        },
      },
      number: {
        currency: {
          style: "currency",
          currency: locale === "de" ? "EUR" : "USD",
        },
        percent: {
          style: "percent",
          minimumFractionDigits: 1,
        },
      },
    },
  }
})
```

### Using Formats

```typescript
// Server component
import { getFormatter } from "next-intl/server"

export default async function Page() {
  const format = await getFormatter()

  return (
    <div>
      <p>{format.dateTime(new Date(), "short")}</p>
      <p>{format.number(1234.56, "currency")}</p>
    </div>
  )
}

// Client component
"use client"
import { useFormatter } from "next-intl"

export function Price({ amount }: { amount: number }) {
  const format = useFormatter()
  return <span>{format.number(amount, "currency")}</span>
}
```

## TypeScript Integration

### Type-Safe Translations

```typescript
// global.d.ts
import en from "./messages/en.json"

type Messages = typeof en

declare global {
  interface IntlMessages extends Messages {}
}
```

### Type-Safe Keys

```typescript
// Now TypeScript knows all valid translation keys
const t = await getTranslations("Navigation")
t("home")      // OK
t("invalid")   // TypeScript error!
```

## Best Practices

| Do | Don't |
|----|-------|
| Use namespaces to organize messages | Put all messages in root |
| Use ICU message format for plurals | Hard-code plural logic |
| Extract strings during development | Wait until the end |
| Use logical CSS properties | Use left/right for layout |
| Provide context for translators | Use cryptic keys |
| Test with pseudo-localization | Only test in default locale |

## i18n Checklist

- [ ] Locale routing configured
- [ ] Middleware detecting locale
- [ ] Message files organized by namespace
- [ ] RTL support if needed
- [ ] Language switcher implemented
- [ ] SEO alternate links set
- [ ] Dates/numbers using formatters
- [ ] Pluralization handled correctly
- [ ] TypeScript types configured
- [ ] Translation workflow documented